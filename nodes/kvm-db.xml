<?xml version="1.0" standalone="no"?>

<kickstart>


<description>
Kvm database tables
</description>


<copyright>
Copyright (c) 2000 - 2007 The Regents of the University of California.
All rights reserved. Rocks(tm) v4.3 www.rocksclusters.org
</copyright>


<changelog>
</changelog>


<post>

<file name="/tmp/kvm-tables.sql">

DROP TABLE IF EXISTS vm_nodes;
CREATE TABLE vm_nodes (
	ID		int(11) NOT NULL auto_increment,
	PhysNode	int(11) NOT NULL default '0',
	Node		int(11) NOT NULL default '0',
	Mem		int(11) NOT NULL default '1024',
	Slice		int(11) NOT NULL default '0',
	Virt_Type	varchar(64) default NULL,
	cdrom_path      varchar(512) default '',
	PRIMARY KEY (ID)
) TYPE=MyISAM;

DROP TABLE IF EXISTS vm_disks;
CREATE TABLE vm_disks (
	ID		int(11) NOT NULL auto_increment,
	Vm_Node		int(11) NOT NULL default '0',
	VBD_Type	varchar(64) default NULL,
	Prefix		varchar(512) default NULL,
	Name		varchar(512) default NULL,
	Device		varchar(512) default NULL,
	Mode		varchar(64) default NULL,
	Size		int(11) NOT NULL default '0',
	PRIMARY KEY (ID)
) TYPE=MyISAM;


--
-- create a view with fe_name vlanid for every cluster to simplify query
--
DROP VIEW IF EXISTS clusters;
CREATE VIEW clusters AS
SELECT n.name as cluster_name, net.vlanid
FROM networks net, nodes n, vm_nodes vmn, memberships mem, subnets sub
WHERE n.id = net.node AND n.id = vmn.node
	AND mem.name = 'Frontend' AND mem.id = n.membership
	AND net.vlanid > 0 AND sub.name = 'private'
	AND sub.id = net.subnet ;

</file>

/opt/rocks/bin/mysql --defaults-extra-file=/root/.rocks.my.cnf \
	--user=root cluster &lt; /tmp/kvm-tables.sql

/opt/rocks/sbin/rocks-db-perms
</post>

</kickstart>

